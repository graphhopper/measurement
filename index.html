<!DOCTYPE html>
<html>
<head>
    <title>GraphHopper Measurement</title>
    <script src="js/plotly-1.5.0.min.js"></script>
    <script src="js/jquery-3.3.1.min.js"></script>
    <style>
            body {
                color: #000;
                font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
                line-height: 1.4;
                color: #111111;
                background-color: #EEEEEE;
                margin: 0;
            }
            #tabs {
                width: 500px;
                margin: 0 auto;
            }

    </style>
</head>
<body>

<div id="chart0">
</div>
<div id="chart1">
</div>

<script>
    var groups = [["routingCH.mean", "routingCH_no_instr.mean", "routingCH_edge.mean"],
                 ["routing.mean"]];
    
    $(document).ready(function (e) {
        // do not display 'not well formed' http://stackoverflow.com/q/335409/194609
        $.ajaxSetup({'beforeSend': function (xhr) {
                if (xhr.overrideMimeType)
                    xhr.overrideMimeType("text/plain");
            }});
        var urls = [];
        var host = "http://localhost:8080/";
        var path = "master-compare.dat?rand=" + Math.random();
        $.ajax({
            type: "GET",
            url: host + path,
            dataType: "text",
            success: function (dataCSV) {
                var dataSeries = processCSV(dataCSV);
                for(var g = 0; g < groups.length; g++) {
                   plot("chart"+g, dataSeries, groups[g]);
                }
            }
        });
    });

    function processCSV(allText) {
        var allTextLines = allText.split(/\r\n|\n/);
        if(allTextLines.length < 1) {
           console.warn("something is broken " + allTextLines.length);
           return;
        }

        var result = {};
        var allHeaders = allTextLines[0].split(',');
        for(var col = 0; col < allHeaders.length; col++) {
           allHeaders[col] = allHeaders[col].trim();
           result[allHeaders[col]] = [];
        }
        
        for (var j = 1; j < allTextLines.length; j++) {
           var line = allTextLines[j];
           var allColumns = line.split(',');
           if(allColumns.length != allHeaders.length) {
              console.warn("skip line " + j + " (cols: " + allColumns.length + ") " + " -> " + line)
              continue;
           }
        
           for(var col = 0; col < allColumns.length; col++) {
              var colStr = allColumns[col].trim();
              var colVal = parseFloat(colStr);
              if(isNaN(colVal))
                colVal = -1;	
              result[allHeaders[col]].push(colVal);
           }
        }
        console.log(result);
        return result;
    }
    
    function plot(divName, dataSeries, traceEntries) {
       var plotArray = [];
       var max = 0;
       for(var entryIdx = 0; entryIdx < traceEntries.length; entryIdx++) {
         var entry = traceEntries[entryIdx];
         var traceData = { x: [], y: [], type: 'scatter', name: entry, connectgaps: false};
         var myarray = dataSeries[entry];
         if(!myarray) {
           console.warn("cannot find '" + entry + "' in data");
           continue;
         }
         plotArray.push(traceData);
         for(var i = 0; i < myarray.length; i++) {
           traceData.x.push(i); // use commit hash or time or date instead?
           traceData.y.push(myarray[i]);
           if(max < myarray[i])
             max = myarray[i];
         }
       }

      var layout = {
        showlegend: true, 
        /*title: traceEntries[0],*/
        yaxis: {
          range: [0, max],
          title: 'ms'
       }};
       Plotly.newPlot(divName, plotArray, layout);
    }

// TODO error_y
//    var data = [
//  {
//    x: [0, 1, 2],
//    y: [6, 10, 2],
//    error_y: {
//      type: 'data',
//      array: [1, 2, 3],
//      visible: true
//    },
//    type: 'scatter'
//  }];

</script>
</body>
</html>